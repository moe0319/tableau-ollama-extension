<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ollama + Tableau 拡張機能</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tableau/extensions-api/lib/tableau.extensions.1.latest.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    .form-group { margin-bottom: 20px; }
    textarea, select, input[type=text] { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
    #data-preview { white-space: pre-wrap; font-family: monospace; background: #f8f8f8; padding: 10px; border: 1px solid #ccc; margin-top: 10px; display: none; }
    #sheet-select-group { display: none; }
  </style>
</head>
<body>
  <h2>Ollama + Tableau 拡張機能</h2>

  <div class="form-group">
    <label for="ollama-url">Ollama サーバー URL:</label>
    <input type="text" id="ollama-url" value="http://localhost:8889">
  </div>

  <div class="form-group">
    <label for="model-select">モデル:</label>
    <select id="model-select">
      <option value="phi4">phi4</option>
      <option value="llama2">llama2</option>
      <option value="mistral">mistral</option>
    </select>
  </div>

  <div class="form-group">
    <label for="prompt">プロンプト:</label>
    <textarea id="prompt" rows="4"></textarea>
  </div>

  <div class="form-group">
    <label><input type="checkbox" id="include-data"> ダッシュボードのデータを含める</label>
  </div>

  <div class="form-group" id="sheet-select-group">
    <label for="sheet-select">ワークシートを選択:</label>
    <select id="sheet-select"></select>
  </div>

  <div id="data-preview"></div>

  <button id="send-button">送信</button>
  <div id="response" style="margin-top: 20px;"></div>

  <script>
    let dashboard = null;
    let currentSheet = null;
    let previewTable = '';

    $(document).ready(function () {
      tableau.extensions.initializeAsync().then(function () {
        dashboard = tableau.extensions.dashboardContent.dashboard;

        $('#include-data').on('change', function () {
          if (this.checked) {
            $('#sheet-select-group').show();
            $('#data-preview').show();
            populateWorksheetDropdown();
          } else {
            $('#sheet-select-group').hide();
            $('#data-preview').hide();
            previewTable = '';
          }
        });

        $('#sheet-select').on('change', function () {
          const selectedName = $(this).val();
          currentSheet = dashboard.worksheets.find(ws => ws.name === selectedName);
          updatePreview(currentSheet);
        });

        $('#send-button').on('click', async function () {
          const url = $('#ollama-url').val().trim();
          const model = $('#model-select').val();
          const prompt = $('#prompt').val().trim();
          const includeData = $('#include-data').is(':checked');
          let finalPrompt = prompt;

          if (includeData && currentSheet) {
            finalPrompt = "以下のTableauデータを参考にしてください:\\n\\n" + previewTable + "\\n\\n" + prompt;
          }

          $('#response').text('送信中...');
          try {
            const res = await fetch(url + "/api/generate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ model: model, prompt: finalPrompt, stream: false })
            });
            const data = await res.json();
            $('#response').text(data.response || '応答がありません');
          } catch (err) {
            $('#response').text('送信エラー: ' + err.message);
          }
        });
      });
    });

    function populateWorksheetDropdown() {
      const $select = $('#sheet-select');
      $select.empty();
      dashboard.worksheets.forEach(sheet => {
        $select.append($('<option>', { value: sheet.name, text: sheet.name }));
      });
      const first = dashboard.worksheets[0];
      $select.val(first.name);
      currentSheet = first;
      updatePreview(first);
    }

    function updatePreview(sheet) {
      $('#data-preview').text('読み込み中...');
      sheet.getSummaryDataAsync().then(function (dataTable) {
        const columns = dataTable.columns.map(c => c.fieldName).join('\\t');
        const rows = dataTable.data.slice(0, 100).map(row =>
          row.map(cell => cell.formattedValue || cell.value || '').join('\\t')
        ).join('\\n');
        previewTable = columns + '\\n' + rows;
        $('#data-preview').text(previewTable);
      }).catch(function (err) {
        $('#data-preview').text('取得エラー: ' + err.message);
        previewTable = '';
      });
    }
  </script>
</body>
</html>
