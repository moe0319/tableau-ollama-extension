<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ollama Tableau Integration</title>

    <script src="https://cdn.jsdelivr.net/npm/@tableau/extensions-api/lib/tableau.extensions.1.latest.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        textarea, select, input {
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }
        button {
            background-color: #2e77d0; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;
        }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #response-area {
            min-height: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 10px;
            margin-top: 10px; background-color: #f9f9f9; white-space: pre-wrap; font-family: monospace;
        }
        .spinner { display: none; margin-left: 10px; vertical-align: middle; }
        .error { color: #dc3545; margin-top: 10px; }
        .success { color: #28a745; margin-top: 10px; }
        .warning {
            background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404;
            padding: 10px; margin-bottom: 15px; border-radius: 4px;
        }
        .data-table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
            font-size: 0.8em;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
        }
        .filters-info {
            margin-top: 10px;
            font-size: 0.8em;
            background-color: #e9f5ff;
            border: 1px solid #b8daff;
            padding: 8px;
            border-radius: 4px;
        }
        .collapsible {
            background-color: #f1f1f1;
            color: #444;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 14px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .active, .collapsible:hover {
            background-color: #e0e0e0;
        }
        .content {
            padding: 0 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background-color: #f9f9f9;
            border-radius: 0 0 4px 4px;
        }
        /* デバッグ用スタイル追加 */
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h2>Ollama Tableau 拡張機能</h2>
    <div class="warning">
        <strong>重要:</strong> CORS制限回避のため、プロキシサーバー(http://localhost:8889)を使用しています。
    </div>

    <!-- デバッグ情報エリア追加 -->
    <div id="debug-info" class="debug-info">初期化ステータス: 待機中...</div>

    <div class="form-group">
        <label for="ollama-url">Ollama サーバーURL:</label>
        <input type="text" id="ollama-url" value="http://localhost:8889" placeholder="http://localhost:8889">
    </div>

    <div class="form-group">
        <label for="model-select">モデル:</label>
        <select id="model-select">
            <option value="phi4">phi4</option>
            <option value="llama2">llama2</option>
            <option value="mistral">mistral</option>
            <option value="gemma">gemma</option>
        </select>
    </div>

    <div class="form-group">
        <label for="prompt-input">プロンプト:</label>
        <textarea id="prompt-input" rows="4" placeholder="Ollamaに送信するプロンプトを入力してください..."></textarea>
    </div>

    <div style="margin-bottom: 15px;">
        <input type="checkbox" id="include-data" checked>
        <label for="include-data" style="display: inline;">ダッシュボードのデータを含める</label>
    </div>

    <div class="form-group" id="sheet-select-group">
        <label for="sheet-select">使用するワークシート:</label>
        <select id="sheet-select"></select>
        <button id="refresh-data" style="margin-top: 5px; background-color: #6c757d;">データを更新</button>
    </div>

    <button class="collapsible">データプレビューとフィルター情報</button>
    <div class="content">
        <div id="filters-info" class="filters-info">
            <p>フィルター情報を読み込み中...</p>
        </div>
        
        <div class="form-group" id="preview-group">
            <label for="data-preview">データプレビュー (最大10行):</label>
            <div id="data-preview" style="overflow-x:auto;"></div>
        </div>
    </div>

    <button id="send-button" style="margin-top: 15px;">送信</button>
    <span class="spinner" id="spinner">処理中...</span>

    <div id="status-message"></div>

    <div class="form-group" style="margin-top: 15px;">
        <label for="response-area">Ollamaの応答:</label>
        <div id="response-area"></div>
    </div>

    <script>
        let sheets = [];
        let currentSheet;
        let dashboard;
        let previewData = null;
        let currentFilters = [];
        let debugInfo = document.getElementById('debug-info');

        // デバッグ情報を更新する関数
        function updateDebugInfo(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `<br>${timestamp}: ${message}`;
            console.log(`DEBUG: ${message}`);
        }

        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM Content Loaded');
            updateDebugInfo('DOM Content Loaded');
            
            // 折りたたみパネルの設定
            const coll = document.getElementsByClassName("collapsible");
            for (let i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    const content = this.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            }
            
            if (typeof tableau !== 'undefined' && tableau.extensions) {
                updateDebugInfo('Tableau Extensions API 検出');
                
                try {
                    // 10秒のタイムアウトを設定
                    const initPromise = tableau.extensions.initializeAsync();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('初期化タイムアウト')), 10000)
                    );
                    
                    Promise.race([initPromise, timeoutPromise])
                        .then(async function () {
                            updateDebugInfo('Tableau extension initialized 成功');
                            
                            try {
                                dashboard = tableau.extensions.dashboardContent.dashboard;
                                updateDebugInfo(`ダッシュボード名: ${dashboard.name}`);
                                
                                // シートの取得方法を変更 - すべてのタイプを取得
                                sheets = dashboard.worksheets.concat(
                                    dashboard.objects
                                        .filter(obj => obj.type === 'worksheet')
                                        .map(obj => obj.worksheet)
                                ).filter(Boolean);
                                
                                updateDebugInfo(`検出されたシート数: ${sheets.length}`);
                                if (sheets.length > 0) {
                                    updateDebugInfo(`シート名一覧: ${sheets.map(s => s.name).join(', ')}`);
                                    populateSheetSelector();
                                    await updateSelectedSheet();
                                    await fetchFiltersInfo();
                                    await refreshDataPreview();
                                } else {
                                    updateDebugInfo('シートが見つかりません');
                                    showError('このダッシュボードにはワークシートがありません');
                                }
                            } catch (innerErr) {
                                updateDebugInfo(`内部エラー: ${innerErr.message}`);
                                console.error('内部エラー:', innerErr);
                                showError('内部エラーが発生しました: ' + innerErr.message);
                            }
                            
                            setupEventListeners();
                            testOllamaConnection();
                        }).catch(function (err) {
                            updateDebugInfo(`初期化エラー: ${err.message}`);
                            console.error('初期化エラー:', err);
                            showError('Tableau拡張機能の初期化に失敗しました: ' + err.message);
                            
                            // 初期化に失敗した場合でも他の機能を有効にする
                            setupEventListeners();
                            document.getElementById('sheet-select-group').style.display = 'none';
                            document.getElementById('preview-group').style.display = 'none';
                            document.querySelector('.collapsible').style.display = 'none';
                            document.getElementById('filters-info').innerHTML = '<p>Tableau拡張機能の初期化に失敗したため、フィルター情報はありません</p>';
                            testOllamaConnection();
                        });
                } catch (err) {
                    updateDebugInfo(`初期化試行エラー: ${err.message}`);
                    console.error('初期化試行エラー:', err);
                    showError('Tableau拡張機能の初期化に失敗しました: ' + err.message);
                }
            } else {
                updateDebugInfo('Tableau API が利用できません - おそらくTableau環境外で実行されています');
                console.log('Running outside Tableau or Tableau API not available');
                setupEventListeners();
                document.getElementById('sheet-select-group').style.display = 'none';
                document.getElementById('preview-group').style.display = 'none';
                document.getElementById('filters-info').innerHTML = '<p>Tableau環境外で実行中のため、フィルター情報はありません</p>';
                testOllamaConnection();
            }
        });

        function setupEventListeners() {
            updateDebugInfo('イベントリスナーを設定');
            document.getElementById('send-button').addEventListener('click', sendPrompt);
            document.getElementById('ollama-url').addEventListener('change', testOllamaConnection);
            document.getElementById('sheet-select').addEventListener('change', async function() {
                await updateSelectedSheet();
                await fetchFiltersInfo();
                await refreshDataPreview();
            });
            document.getElementById('include-data').addEventListener('change', function() {
                const includeData = document.getElementById('include-data').checked;
                document.getElementById('sheet-select-group').style.display = includeData ? 'block' : 'none';
                const collapsible = document.querySelector('.collapsible');
                collapsible.style.display = includeData ? 'block' : 'none';
                if (!includeData) {
                    const content = collapsible.nextElementSibling;
                    content.style.maxHeight = null;
                }
            });
            document.getElementById('refresh-data').addEventListener('click', async function() {
                await fetchFiltersInfo();
                await refreshDataPreview();
            });
        }

        function populateSheetSelector() {
            updateDebugInfo('ワークシートセレクターを更新');
            const sheetSelect = document.getElementById('sheet-select');
            sheetSelect.innerHTML = '';
            
            if (sheets.length === 0) {
                updateDebugInfo('シートが見つからないため、セレクターを更新できません');
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- 利用可能なワークシートがありません --';
                sheetSelect.appendChild(option);
                return;
            }
            
            sheets.forEach(function(worksheet) {
                const option = document.createElement('option');
                option.value = worksheet.name;
                option.textContent = worksheet.name;
                sheetSelect.appendChild(option);
                updateDebugInfo(`シートをセレクターに追加: ${worksheet.name}`);
            });
        }

        async function updateSelectedSheet() {
            const selectedSheetName = document.getElementById('sheet-select').value;
            updateDebugInfo(`選択されたシート名: ${selectedSheetName}`);
            
            if (!selectedSheetName) {
                updateDebugInfo('シート名が空です');
                currentSheet = null;
                return;
            }
            
            currentSheet = sheets.find(sheet => sheet.name === selectedSheetName);
            updateDebugInfo(`選択シート: ${currentSheet ? currentSheet.name : 'None'}`);
            
            // ワークシートが変更されたらフィルターイベントリスナーを設定
            if (currentSheet) {
                try {
                    // 以前のリスナーを削除（必要に応じて）
                    // ここではシンプルに新しいリスナーを追加
                    currentSheet.addEventListener(tableau.TableauEventType.FilterChanged, async function(filterEvent) {
                        updateDebugInfo(`フィルター変更: ${filterEvent}`);
                        await fetchFiltersInfo();
                        await refreshDataPreview();
                    });
                    updateDebugInfo('フィルターイベントリスナーを設定しました');
                } catch (err) {
                    updateDebugInfo(`イベントリスナー設定エラー: ${err.message}`);
                    console.error('イベントリスナー設定エラー:', err);
                }
            }
        }

        async function fetchFiltersInfo() {
            if (!currentSheet) {
                updateDebugInfo('現在のシートがないため、フィルター情報を取得できません');
                return;
            }
            
            const filtersInfo = document.getElementById('filters-info');
            filtersInfo.innerHTML = '<p>フィルター情報を読み込み中...</p>';
            updateDebugInfo('フィルター情報を取得中...');
            
            try {
                currentFilters = await currentSheet.getFiltersAsync();
                updateDebugInfo(`${currentFilters.length}個のフィルターを取得しました`);
                
                if (currentFilters.length === 0) {
                    filtersInfo.innerHTML = '<p>このワークシートには適用されているフィルターがありません</p>';
                    return;
                }
                
                let filterHtml = '<h4>適用されているフィルター:</h4><ul>';
                
                currentFilters.forEach(function(filter) {
                    filterHtml += `<li><strong>${filter.fieldName}</strong> (${filter.filterType}): ${getFilterValues(filter)}</li>`;
                });
                
                filterHtml += '</ul>';
                filtersInfo.innerHTML = filterHtml;
                
                // 折りたたみパネルの高さを更新
                const content = document.querySelector('.content');
                if (content.style.maxHeight) {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            } catch (error) {
                updateDebugInfo(`フィルター取得エラー: ${error.message}`);
                console.error('フィルター取得エラー:', error);
                filtersInfo.innerHTML = '<p>フィルター情報の取得に失敗しました: ' + error.message + '</p>';
            }
        }
        
        // フィルター値を文字列で取得する関数
        function getFilterValues(filter) {
            let filterValues = '';

            switch (filter.filterType) {
                case 'categorical':
                    if (filter.appliedValues && filter.appliedValues.length > 0) {
                        filter.appliedValues.forEach(function(value) {
                            filterValues += value.formattedValue + ', ';
                        });
                        // 最後のカンマとスペースを削除
                        filterValues = filterValues.slice(0, -2);
                    } else {
                        filterValues = '(値なし)';
                    }
                    break;
                case 'range':
                    // 範囲フィルターは最小値と最大値を持つことがある
                    if (filter.minValue) {
                        filterValues += '最小: ' + filter.minValue.formattedValue;
                    }
                    if (filter.minValue && filter.maxValue) {
                        filterValues += ', ';
                    }
                    if (filter.maxValue) {
                        filterValues += '最大: ' + filter.maxValue.formattedValue;
                    }
                    if (!filterValues) {
                        filterValues = '(範囲なし)';
                    }
                    break;
                case 'relative-date':
                    filterValues += '期間: ' + filter.periodType;
                    if (filter.rangeN !== undefined) {
                        filterValues += ', 範囲: ' + filter.rangeN;
                    }
                    if (filter.rangeType) {
                        filterValues += ', タイプ: ' + filter.rangeType;
                    }
                    break;
                default:
                    filterValues = '(不明なフィルター形式)';
            }

            return filterValues;
        }

        async function refreshDataPreview() {
            if (!currentSheet) {
                updateDebugInfo('現在のシートがないため、データプレビューを取得できません');
                return;
            }
            
            const dataPreview = document.getElementById('data-preview');
            dataPreview.innerHTML = '<p>データ読み込み中...</p>';
            updateDebugInfo('データプレビューを取得中...');
            
            try {
                // データの取得
                const dataTable = await currentSheet.getSummaryDataAsync();
                previewData = dataTable;
                updateDebugInfo(`データ取得成功: ${dataTable.data.length}行`);
                
                // データが空かどうかチェック
                if (!dataTable || !dataTable.data || dataTable.data.length === 0) {
                    dataPreview.innerHTML = '<p>データがありません</p>';
                    updateDebugInfo('データが空です');
                    return;
                }
                
                // テーブルの作成
                const table = document.createElement('table');
                table.className = 'data-table';
                
                // ヘッダー行の作成
                const headerRow = document.createElement('tr');
                dataTable.columns.forEach(column => {
                    const th = document.createElement('th');
                    th.textContent = column.fieldName;
                    headerRow.appendChild(th);
                });
                
                const thead = document.createElement('thead');
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // データ行の作成（最大10行まで）
                const tbody = document.createElement('tbody');
                const maxRows = Math.min(dataTable.data.length, 10);
                
                for (let i = 0; i < maxRows; i++) {
                    const dataRow = dataTable.data[i];
                    const tr = document.createElement('tr');
                    
                    dataTable.columns.forEach((column, colIndex) => {
                        const td = document.createElement('td');
                        td.textContent = dataRow[colIndex].formattedValue || dataRow[colIndex].value || '';
                        tr.appendChild(td);
                    });
                    
                    tbody.appendChild(tr);
                }
                
                table.appendChild(tbody);
                
                // テーブルをプレビュー領域に追加
                dataPreview.innerHTML = '';
                dataPreview.appendChild(table);
                
                // 合計行数の表示
                const totalRows = document.createElement('p');
                totalRows.textContent = `全 ${dataTable.data.length} 行中 ${maxRows} 行を表示しています。`;
                totalRows.style.marginTop = '5px';
                totalRows.style.fontSize = '0.8em';
                dataPreview.appendChild(totalRows);
                
                // 折りたたみパネルの高さを更新
                const content = document.querySelector('.content');
                if (content.style.maxHeight) {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
                
                showSuccess('データを取得しました');
            } catch (error) {
                updateDebugInfo(`データ取得エラー: ${error.message}`);
                console.error('データ取得エラー:', error);
                dataPreview.innerHTML = '<p>データの取得に失敗しました: ' + error.message + '</p>';
                showError('データの取得に失敗しました: ' + error.message);
            }
        }

        async function testOllamaConnection() {
            const ollamaUrl = document.getElementById('ollama-url').value.trim();
            updateDebugInfo(`Ollama接続テスト: ${ollamaUrl}`);
            
            try {
                const response = await fetch(ollamaUrl, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    updateDebugInfo('Ollama接続成功');
                    showSuccess('Ollamaサーバーに接続できました');
                    
                    // モデル一覧を取得
                    try {
                        const tagsResponse = await fetch(`${ollamaUrl}/api/tags`, {
                            method: 'GET'
                        });
                        
                        if (tagsResponse.ok) {
                            const tagsData = await tagsResponse.json();
                            updateModelSelector(tagsData);
                            updateDebugInfo(`モデル一覧取得成功: ${tagsData.models ? tagsData.models.length : 0}個のモデル`);
                        }
                    } catch (tagsError) {
                        updateDebugInfo(`モデル一覧取得エラー: ${tagsError.message}`);
                        console.log('モデル一覧の取得に失敗しました:', tagsError);
                        // モデル一覧取得失敗は致命的でないのでエラー表示はしない
                    }
                } else {
                    updateDebugInfo(`Ollama応答エラー: ${response.status}`);
                    showError('Ollamaサーバーの応答エラー: ' + response.status);
                }
            } catch (error) {
                updateDebugInfo(`Ollama接続エラー: ${error.message}`);
                console.error('接続テストエラー:', error);
                showError('Ollamaサーバーに接続できません: ' + error.message);
            }
        }
        
        function updateModelSelector(tagsData) {
            if (!tagsData || !tagsData.models || tagsData.models.length === 0) {
                updateDebugInfo('利用可能なモデルがありません');
                return;
            }
            
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = '';
            
            tagsData.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = model.name;
                modelSelect.appendChild(option);
                updateDebugInfo(`モデルをセレクターに追加: ${model.name}`);
            });
        }

        async function sendPrompt() {
            const ollamaUrl = document.getElementById('ollama-url').value.trim();
            const modelName = document.getElementById('model-select').value;
            const promptInput = document.getElementById('prompt-input').value.trim();
            const includeData = document.getElementById('include-data').checked;
            const responseArea = document.getElementById('response-area');
            const spinner = document.getElementById('spinner');
            const sendButton = document.getElementById('send-button');
            
            if (!promptInput) {
                alert('プロンプトを入力してください');
                return;
            }
            
            // 送信中の表示
            spinner.style.display = 'inline';
            sendButton.disabled = true;
            responseArea.textContent = '処理中...';
            showStatus('リクエスト送信中...');
            updateDebugInfo(`プロンプト送信: モデル=${modelName}, データ含む=${includeData}`);
            
            // プロンプトを作成
            let finalPrompt = promptInput;
            
            if (includeData && currentSheet && previewData) {
                try {
                    // プレビューデータを文字列に変換
                    let tableText = '';
                    
                    // ヘッダー行
                    const headers = previewData.columns.map(col => col.fieldName);
                    tableText += headers.join('\t') + '\n';
                    
                    // データ行
                    for (let i = 0; i < previewData.data.length; i++) {
                        const row = previewData.data[i];
                        const rowValues = [];
                        
                        for (let j = 0; j < row.length; j++) {
                            rowValues.push(row[j].formattedValue || row[j].value || '');
                        }
                        
                        tableText += rowValues.join('\t') + '\n';
                    }
                    
                    // フィルター情報を追加
                    let filtersText = '';
                    if (currentFilters && currentFilters.length > 0) {
                        filtersText = '\n適用中のフィルター:\n';
                        currentFilters.forEach(function(filter) {
                            filtersText += `- ${filter.fieldName} (${filter.filterType}): ${getFilterValues(filter)}\n`;
                        });
                    }
                    
                    // プロンプトにデータとフィルター情報を追加
                    finalPrompt = `以下のTableauデータを分析して回答してください:${filtersText}\n${tableText}\n\n${promptInput}`;
                    updateDebugInfo('データとフィルター情報を含むプロンプトを作成しました');
                } catch (error) {
                    updateDebugInfo(`データ変換エラー: ${error.message}`);
                    console.error('データ変換エラー:', error);
                    showError('データの変換に失敗しました: ' + error.message);
                    spinner.style.display = 'none';
                    sendButton.disabled = false;
                    return;
                }
            }
            
            // Ollamaへリクエストを送信
            try {
                updateDebugInfo(`Ollamaにリクエスト送信中: ${ollamaUrl}`);
                
                const response = await fetch(`${ollamaUrl}/api/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: modelName,
                        prompt: finalPrompt,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                updateDebugInfo('レスポンス受信');
                
                if (data && data.response) {
                    responseArea.textContent = data.response;
                    showSuccess('応答を受信しました');
                } else {
                    responseArea.textContent = 'レスポンスが空か不正な形式です';
                    showError('不正なレスポンス形式');
                }
            } catch (error) {
                updateDebugInfo(`Ollamaリクエストエラー: ${error.message}`);
                console.error('Ollamaリクエストエラー:', error);
                showError('エラーが発生しました: ' + error.message);
                responseArea.textContent = '';
            } finally {
                spinner.style.display = 'none';
                sendButton.disabled = false;
            }
        }

        function showError(message) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = message;
            statusMessage.className = '';
            updateDebugInfo(`ステータス: ${message}`);
        }
    </script>
</body>
</html>.getElementById('status-message');
            statusMessage.textContent = message;
            statusMessage.className = 'error';
            updateDebugInfo(`エラー: ${message}`);
        }
        
        function showSuccess(message) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = message;
            statusMessage.className = 'success';
            updateDebugInfo(`成功: ${message}`);
        }
        
