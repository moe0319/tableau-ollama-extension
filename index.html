<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ollama Tableau Integration</title>

    <script src="https://cdn.jsdelivr.net/npm/@tableau/extensions-api/lib/tableau.extensions.1.latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        textarea, select, input {
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }
        button {
            background-color: #2e77d0; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;
        }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #response-area {
            min-height: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 10px;
            margin-top: 10px; background-color: #f9f9f9; white-space: pre-wrap; font-family: monospace;
        }
        .spinner { display: none; margin-left: 10px; vertical-align: middle; }
        .error { color: #dc3545; margin-top: 10px; }
        .success { color: #28a745; margin-top: 10px; }
        .warning {
            background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404;
            padding: 10px; margin-bottom: 15px; border-radius: 4px;
        }
        .sheet-selector {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .sheet-selector input[type="checkbox"] {
            margin-right: 5px;
        }
        .column-selector {
            margin-top: 5px;
            margin-left: 20px;
            padding: 5px;
            border-left: 1px solid #ddd;
            display: none;
        }
    </style>
</head>
<body>
    <h2>Ollama Tableau 拡張機能</h2>
    <div class="warning">
        <strong>重要:</strong> CORS制限回避のため、CORS拡張機能を使うかEdgeを特別モード(--disable-web-security)で起動してください。
    </div>

    <div class="form-group">
        <label for="ollama-url">Ollama サーバーURL:</label>
        <input type="text" id="ollama-url" value="http://localhost:8889" placeholder="http://localhost:8889">
    </div>

    <div class="form-group">
        <label for="model-select">モデル:</label>
        <select id="model-select">
            <option value="phi4">phi4</option>
            <option value="llama2">llama2</option>
            <option value="mistral">mistral</option>
            <option value="gemma">gemma</option>
        </select>
    </div>

    <div class="form-group">
        <label for="prompt-input">プロンプト:</label>
        <textarea id="prompt-input" rows="4" placeholder="Ollamaに送信するプロンプトを入力してください..."></textarea>
    </div>

    <div style="margin-bottom: 15px;">
        <input type="checkbox" id="include-data" checked>
        <label for="include-data" style="display: inline;">ダッシュボードのデータを含める</label>
    </div>

    <div id="sheets-container" style="display: none;">
        <h3>使用するワークシート:</h3>
        <div id="sheet-selectors">
            <!-- シート選択がここに動的に生成されます -->
        </div>
    </div>

    <div class="form-group" id="data-format-group" style="display: none;">
        <label for="data-format-select">データフォーマット:</label>
        <select id="data-format-select">
            <option value="raw">テキスト形式</option>
            <option value="table">テーブル形式</option>
            <option value="json">JSON形式</option>
        </select>
    </div>

    <button id="preview-button" style="display: none; margin-right: 10px;">プレビュー</button>
    <button id="send-button">送信</button>
    <span class="spinner" id="spinner">処理中...</span>

    <div id="status-message"></div>

    <div class="form-group" id="preview-group" style="display: none;">
        <label for="data-preview">データプレビュー:</label>
        <div id="data-preview" style="overflow-x:auto; border:1px solid #ddd; padding:10px; background:#f1f1f1; font-family:monospace; max-height: 300px; overflow-y: auto;"></div>
    </div>

    <div class="form-group">
        <label for="response-area">Ollamaの応答:</label>
        <div id="response-area"></div>
    </div>

    <script>
        let dashboard;
        let sheetsMeta = [];
        
        // func.jsからインポートする関数のエミュレーション
        const initializeMeta = async () => {
            console.log('Initializing Meta');
            let meta = [];
            const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
            
            for (let i = 0; i < worksheets.length; i++) {
                const sheet = worksheets[i];
                let item = {
                    sheetName: sheet.name,
                    selected: false,
                    changeName: null,
                    customCols: false
                };
                
                try {
                    const data = await sheet.getSummaryDataAsync({ignoreSelection: true});
                    const columns = data.columns;
                    let cols = [];
                    
                    for (let k = 0; k < columns.length; k++) {
                        let newCol = {};
                        newCol.index = columns[k].index;
                        newCol.name = columns[k].fieldName;
                        newCol.dataType = columns[k].dataType;
                        newCol.selected = true;
                        newCol.order = k + 1;
                        cols.push(newCol);
                    }
                    
                    item.columns = cols;
                } catch (error) {
                    console.error(`Error getting data for ${sheet.name}:`, error);
                }
                
                meta.push(item);
            }
            
            return meta;
        };
        
        const decodeDataset = async (columns, dataset) => {
            let rows = [];
            for (let i = 0; i < dataset.length; i++) {
                rows.push(await decodeRow(columns, dataset[i]));
            }
            return rows;
        };
        
        const decodeRow = async (columns, row) => {
            let meta = {};
            for (let j = 0; j < columns.length; j++) {
                if (columns[j].selected) {
                    let val;
                    if (row[j].value === '%null%' && row[j].nativeValue === null && row[j].formattedValue === 'Null') {
                        val = null;
                    } else {
                        val = row[j].formattedValue;
                    }
                    meta[columns[j].outputName || columns[j].name] = val;
                }
            }
            return meta;
        };

        document.addEventListener('DOMContentLoaded', function () {
            if (typeof tableau !== 'undefined') {
                tableau.extensions.initializeAsync().then(async function () {
                    dashboard = tableau.extensions.dashboardContent.dashboard;
                    sheetsMeta = await initializeMeta();
                    setupEventListeners();
                    renderSheetSelectors();
                    testOllamaConnection();
                }).catch(function (err) {
                    showError('初期化に失敗しました: ' + err);
                });
            } else {
                setupEventListeners();
                testOllamaConnection();
            }
        });

        function setupEventListeners() {
            document.getElementById('send-button').addEventListener('click', sendPrompt);
            document.getElementById('ollama-url').addEventListener('change', testOllamaConnection);
            document.getElementById('include-data').addEventListener('change', toggleDataOptions);
            
            if (document.getElementById('preview-button')) {
                document.getElementById('preview-button').addEventListener('click', showDataPreview);
            }
        }

        function toggleDataOptions() {
            const includeData = document.getElementById('include-data').checked;
            document.getElementById('sheets-container').style.display = includeData ? 'block' : 'none';
            document.getElementById('data-format-group').style.display = includeData ? 'block' : 'none';
            document.getElementById('preview-button').style.display = includeData ? 'inline-block' : 'none';
        }

        function renderSheetSelectors() {
            const container = document.getElementById('sheet-selectors');
            container.innerHTML = '';
            
            sheetsMeta.forEach((sheetMeta, index) => {
                const sheetDiv = document.createElement('div');
                sheetDiv.className = 'sheet-selector';
                
                const sheetCheckbox = document.createElement('input');
                sheetCheckbox.type = 'checkbox';
                sheetCheckbox.id = `sheet-${index}`;
                sheetCheckbox.checked = false;
                sheetCheckbox.addEventListener('change', (e) => {
                    sheetsMeta[index].selected = e.target.checked;
                    document.getElementById(`columns-${index}`).style.display = e.target.checked ? 'block' : 'none';
                });
                
                const sheetLabel = document.createElement('label');
                sheetLabel.htmlFor = `sheet-${index}`;
                sheetLabel.style.display = 'inline';
                sheetLabel.textContent = sheetMeta.sheetName;
                
                sheetDiv.appendChild(sheetCheckbox);
                sheetDiv.appendChild(sheetLabel);
                
                // カラム選択コンテナを作成
                const columnsDiv = document.createElement('div');
                columnsDiv.id = `columns-${index}`;
                columnsDiv.className = 'column-selector';
                
                if (sheetMeta.columns && sheetMeta.columns.length > 0) {
                    sheetMeta.columns.forEach((column, colIndex) => {
                        const colDiv = document.createElement('div');
                        
                        const colCheckbox = document.createElement('input');
                        colCheckbox.type = 'checkbox';
                        colCheckbox.id = `col-${index}-${colIndex}`;
                        colCheckbox.checked = column.selected;
                        colCheckbox.addEventListener('change', (e) => {
                            sheetsMeta[index].columns[colIndex].selected = e.target.checked;
                        });
                        
                        const colLabel = document.createElement('label');
                        colLabel.htmlFor = `col-${index}-${colIndex}`;
                        colLabel.style.display = 'inline';
                        colLabel.textContent = column.name;
                        
                        colDiv.appendChild(colCheckbox);
                        colDiv.appendChild(colLabel);
                        columnsDiv.appendChild(colDiv);
                    });
                }
                
                sheetDiv.appendChild(columnsDiv);
                container.appendChild(sheetDiv);
            });
        }

        async function showDataPreview() {
            const preview = document.getElementById('data-preview');
            const previewGroup = document.getElementById('preview-group');
            previewGroup.style.display = 'block';
            preview.textContent = '読み込み中...';
            
            const format = document.getElementById('data-format-select').value;
            const selectedSheets = sheetsMeta.filter(s => s.selected);
            
            if (selectedSheets.length === 0) {
                preview.textContent = 'シートが選択されていません。';
                return;
            }
            
            try {
                const previewData = await getFormattedData(format);
                preview.textContent = previewData;
            } catch (err) {
                preview.textContent = 'プレビュー取得失敗: ' + err.message;
            }
        }

        async function getFormattedData(format) {
            const selectedSheets = sheetsMeta.filter(s => s.selected);
            const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
            let formattedData = '';
            
            switch (format) {
                case 'raw':
                    for (const sheetMeta of selectedSheets) {
                        const sheet = worksheets.find(ws => ws.name === sheetMeta.sheetName);
                        if (!sheet) continue;
                        
                        const data = await sheet.getSummaryDataAsync({ignoreSelection: true});
                        const selectedColumns = sheetMeta.columns.filter(col => col.selected);
                        const columnNames = selectedColumns.map(col => col.name);
                        
                        formattedData += `# ${sheetMeta.sheetName}\n`;
                        formattedData += columnNames.join('\t') + '\n';
                        
                        for (let i = 0; i < data.data.length; i++) {
                            const row = data.data[i];
                            const formattedRow = selectedColumns.map(col => {
                                const colIndex = sheetMeta.columns.findIndex(c => c.name === col.name);
                                return row[colIndex].formattedValue || row[colIndex].value || '';
                            }).join('\t');
                            formattedData += formattedRow + '\n';
                        }
                        formattedData += '\n';
                    }
                    break;
                    
                case 'table':
                    for (const sheetMeta of selectedSheets) {
                        const sheet = worksheets.find(ws => ws.name === sheetMeta.sheetName);
                        if (!sheet) continue;
                        
                        const data = await sheet.getSummaryDataAsync({ignoreSelection: true});
                        const selectedColumns = sheetMeta.columns.filter(col => col.selected);
                        
                        formattedData += `# ${sheetMeta.sheetName}\n`;
                        formattedData += '| ' + selectedColumns.map(col => col.name).join(' | ') + ' |\n';
                        formattedData += '| ' + selectedColumns.map(() => '---').join(' | ') + ' |\n';
                        
                        for (let i = 0; i < Math.min(data.data.length, 50); i++) {
                            const row = data.data[i];
                            const formattedRow = selectedColumns.map(col => {
                                const colIndex = sheetMeta.columns.findIndex(c => c.name === col.name);
                                return row[colIndex].formattedValue || row[colIndex].value || '';
                            }).join(' | ');
                            formattedData += '| ' + formattedRow + ' |\n';
                        }
                        formattedData += '\n';
                    }
                    break;
                    
                case 'json':
                    const jsonData = {};
                    
                    for (const sheetMeta of selectedSheets) {
                        const sheet = worksheets.find(ws => ws.name === sheetMeta.sheetName);
                        if (!sheet) continue;
                        
                        const data = await sheet.getSummaryDataAsync({ignoreSelection: true});
                        const selectedColumns = sheetMeta.columns.filter(col => col.selected);
                        
                        const columns = data.columns.map((col, idx) => {
                            const colMeta = selectedColumns.find(c => c.name === col.fieldName);
                            if (colMeta) {
                                return { ...col, selected: true, outputName: colMeta.changeName || colMeta.name };
                            } else {
                                return { ...col, selected: false };
                            }
                        }).filter(col => col.selected);
                        
                        const rows = await decodeDataset(columns, data.data);
                        jsonData[sheetMeta.sheetName] = rows;
                    }
                    
                    formattedData = JSON.stringify(jsonData, null, 2);
                    break;
            }
            
            return formattedData;
        }

        async function testOllamaConnection() {
            const ollamaUrl = document.getElementById('ollama-url').value.trim();
            try {
                const response = await fetch(ollamaUrl, { method: 'GET' });
                if (response.ok) showSuccess('Ollamaサーバーに接続できました');
                else showError('応答エラー: ' + response.status);
            } catch (error) {
                showError('接続失敗: ' + error.message);
            }
        }

        async function sendPrompt() {
            const ollamaUrl = document.getElementById('ollama-url').value.trim();
            const modelName = document.getElementById('model-select').value;
            const promptInput = document.getElementById('prompt-input').value.trim();
            const includeData = document.getElementById('include-data').checked;
            const responseArea = document.getElementById('response-area');
            const spinner = document.getElementById('spinner');
            const sendButton = document.getElementById('send-button');

            if (!promptInput) {
                alert('プロンプトを入力してください');
                return;
            }

            spinner.style.display = 'inline';
            sendButton.disabled = true;
            responseArea.textContent = '処理中...';
            showStatus('送信中...');

            let finalPrompt = promptInput;
            
            if (includeData && typeof tableau !== 'undefined') {
                try {
                    const format = document.getElementById('data-format-select').value;
                    const formattedData = await getFormattedData(format);
                    
                    if (formattedData) {
                        finalPrompt = `以下のTableauデータを分析して回答してください:

${formattedData}

質問: ${promptInput}`;
                    }
                } catch (error) {
                    showError('データ取得失敗: ' + error.message);
                    spinner.style.display = 'none';
                    sendButton.disabled = false;
                    return;
                }
            }

            try {
                const response = await fetch(`${ollamaUrl}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName, prompt: finalPrompt, stream: false })
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                responseArea.textContent = data.response || 'レスポンスが空です';
                showSuccess('応答を受信しました');
            } catch (error) {
                showError('送信失敗: ' + error.message);
                responseArea.textContent = '';
            } finally {
                spinner.style.display = 'none';
                sendButton.disabled = false;
            }
        }

        function showError(msg) {
            const status = document.getElementById('status-message');
            status.textContent = msg; status.className = 'error';
        }
        function showSuccess(msg) {
            const status = document.getElementById('status-message');
            status.textContent = msg; status.className = 'success';
        }
        function showStatus(msg) {
            const status = document.getElementById('status-message');
            status.textContent = msg; status.className = '';
        }
    </script>
</body>
</html>
